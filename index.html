<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Academy System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .hidden { display: none !important; }
        
        /* Login */
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            margin: 0 auto 15px;
        }
        
        .login-logo h1 {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .login-logo p {
            color: #64748b;
            font-size: 13px;
        }
        
        .tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: #f8fafc;
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .tab {
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1e293b;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-group label::after {
            content: attr(data-required);
            color: #ef4444;
            margin-left: 2px;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        input::placeholder {
            color: #cbd5e1;
        }
        
        input:invalid {
            border-color: #ef4444;
        }
        
        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-wrapper input {
            padding-right: 45px;
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #64748b;
        }
        
        .error-input {
            border-color: #ef4444 !important;
            background-color: #fee2e2 !important;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 5px;
            font-weight: 500;
            display: block;
            min-height: 16px;
        }
        
        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
        }
        
        .dashboard.show {
            display: block;
        }
        
        .top-bar {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .top-left h1 {
            font-size: 24px;
            font-weight: 800;
            color: #1e293b;
        }
        
        .top-left p {
            color: #64748b;
            font-size: 13px;
        }
        
        .top-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }
        
        .user-info h3 {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
        }
        
        .user-info p {
            font-size: 11px;
            color: #64748b;
        }
        
        .btn-logout {
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }
        
        .content {
            padding: 0 20px 20px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-num {
            font-size: 28px;
            font-weight: 800;
            color: #6366f1;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .card.selected {
            border-color: #6366f1;
            background: #f0f4ff;
        }
        
        .card-name {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .card-meta {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 10px;
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
        }
        
        .btn-call {
            background: #10b981;
            color: white;
        }
        
        .btn-call:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
        }
        
        .list-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
        }
        
        .search {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        /* Floating Call Modal */
        .call-modal {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 400px;
            max-width: 90vw;
            z-index: 1000;
            display: none;
            flex-direction: column;
            transform: translateY(500px);
            transition: all 0.3s ease;
        }
        
        .call-modal.active {
            display: flex;
            transform: translateY(0);
        }
        
        .call-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .call-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .call-status {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .call-timer {
            font-size: 24px;
            font-weight: 700;
            margin-top: 10px;
            font-family: monospace;
        }
        
        .call-body {
            padding: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connecting {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }
        
        .status-active {
            background: #10b981;
            animation: pulse 1.5s infinite;
        }
        
        .status-failed {
            background: #ef4444;
        }
        
        .status-ended {
            background: #64748b;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .call-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-end-call {
            flex: 1;
            padding: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-end-call:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        
        .btn-retry {
            flex: 1;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        
        .call-info {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #64748b;
        }
        
        .error-box {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            color: #991b1b;
            font-size: 13px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 450px;
            width: 90%;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-save {
            flex: 1;
            padding: 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-cancel {
            flex: 1;
            padding: 12px;
            background: #e2e8f0;
            color: #1e293b;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-add {
            padding: 16px 28px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            width: 100%;
            margin-top: 20px;
            margin-bottom: 10px;
            display: block;
            text-align: center;
            min-height: 50px;
            line-height: 50px;
        }
        
        .btn-add:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
            background: linear-gradient(135deg, #5558e3, #7c3aed);
        }
        
        .btn-add:active {
            transform: translateY(-1px);
        }
        
        .modal-info {
            background: #f0f4ff;
            border: 2px solid #6366f1;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            font-size: 13px;
            color: #6366f1;
            display: none;
        }
        
        .modal-info.show {
            display: block;
        }
        
        .modal-info.success {
            background: #dcfce7;
            border-color: #10b981;
            color: #065f46;
        }
        
        .modal-info.error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        
        .modal-info.info {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .admin-only {
            display: none !important;
        }
        
        .admin-only.visible {
            display: block !important;
        }
        
        /* Alert Popup */
        .alert-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }
        
        .alert-popup.error {
            border-left: 4px solid #ef4444;
        }
        
        .alert-popup.success {
            border-left: 4px solid #10b981;
        }
        
        .alert-text {
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <div class="logo-icon">üìñ</div>
                <h1>Quran Academy</h1>
                <p>Student Management System</p>
            </div>
            
            <div class="tabs">
                <button class="tab active" id="tabAdmin" onclick="APP.switchTab('admin')">Admin</button>
                <button class="tab" id="tabStaff" onclick="APP.switchTab('staff')">Teacher</button>
            </div>
            
            <div id="formAdmin">
                <div class="form-group">
                    <label>Admin Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="passAdmin" placeholder="Enter admin password">
                        <button type="button" class="toggle-password" onclick="APP.togglePassword('passAdmin')">üëÅÔ∏è</button>
                    </div>
                    <div id="passAdminError" class="error-message"></div>
                </div>
                <button class="btn-login" onclick="APP.loginAdmin()">Login as Admin</button>
            </div>
            
            <div id="formStaff" class="hidden">
                <div class="form-group">
                    <label>Teacher Email</label>
                    <input type="email" id="emailStaff" placeholder="Enter your email">
                    <div id="emailStaffError" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="passStaff" placeholder="Enter password">
                        <button type="button" class="toggle-password" onclick="APP.togglePassword('passStaff')">üëÅÔ∏è</button>
                    </div>
                    <div id="passStaffError" class="error-message"></div>
                </div>
                <button class="btn-login" onclick="APP.loginStaff()">Login as Teacher</button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="top-bar">
            <div class="top-left">
                <h1>üìä Dashboard</h1>
                <p id="lastUpdate">Connected</p>
            </div>
            <div class="top-right">
                <div class="user">
                    <div class="avatar" id="avatar">A</div>
                    <div class="user-info">
                        <h3 id="username">Admin</h3>
                        <p id="role">Administrator</p>
                    </div>
                </div>
                <button class="btn-logout" onclick="APP.logout()">Logout</button>
            </div>
        </div>
        
        <div class="content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-num" id="statStudents">0</div>
                    <div class="stat-label">Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-num" id="statCalls">0</div>
                    <div class="stat-label">Calls Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-num" id="statMinutes">0</div>
                    <div class="stat-label">Minutes</div>
                </div>
            </div>
            
            <div class="grid-2">
                <!-- Students List -->
                <div class="list-box">
                    <div class="section-title">üë• Students</div>
                    <input type="text" class="search" id="searchStudents" placeholder="Search..." onkeyup="APP.renderStudents()">
                    <div id="studentsList"></div>
                    <button class="btn-add admin-only" onclick="APP.openModal()">‚ûï Add New Student</button>
                </div>
                
                <!-- Call History -->
                <div class="list-box">
                    <div class="section-title">üìû Call History</div>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Call Modal -->
    <div id="callModal" class="call-modal">
        <div class="call-header">
            <div class="call-name" id="callName">-</div>
            <div class="call-status">
                <span class="status-indicator" id="callStatusIndicator"></span>
                <span id="callStatusText">Ready</span>
            </div>
            <div class="call-timer" id="callTimer">00:00</div>
        </div>
        <div class="call-body">
            <div class="call-info" id="callInfo"></div>
            <div id="errorBox" class="error-box hidden"></div>
            <div class="call-actions">
                <button class="btn-end-call" id="btnEndCall" onclick="APP.hangupCall()" disabled>‚úã Hangup</button>
                <button class="btn-retry" id="btnRetry" onclick="APP.retryCall()" class="hidden">üîÑ Retry</button>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">‚ûï Add New Student</div>
            
            <div class="form-group">
                <label>üìù Student Name *</label>
                <input type="text" id="inName" placeholder="e.g., Ahmed Mohammed" required>
                <div id="nameError" class="error-message"></div>
            </div>
            
            <div class="form-group">
                <label>üì± Phone Number (10 digits) *</label>
                <input type="tel" id="inPhone" placeholder="e.g., 2025551234" maxlength="14" required>
                <div id="phoneError" class="error-message"></div>
            </div>
            
            <div class="form-group">
                <label>‚úâÔ∏è Email Address</label>
                <input type="email" id="inEmail" placeholder="e.g., student@example.com">
                <div id="emailError" class="error-message"></div>
            </div>
            
            <div class="form-group">
                <label>üë®‚Äçüë©‚Äçüëß Parent/Guardian Name</label>
                <input type="text" id="inParent" placeholder="e.g., Parent Name">
                <div id="parentError" class="error-message"></div>
            </div>
            
            <div class="modal-info" id="formInfo"></div>
            
            <div class="modal-buttons">
                <button class="btn-save" onclick="APP.saveStudent()">‚úÖ Save Student</button>
                <button class="btn-cancel" onclick="APP.closeModal()">‚ùå Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // VERSION 4.0 - Real-time sync with aggressive fallbacks
        const APP_VERSION = '4.0';
        console.log('üöÄ Quran Academy Dialer v' + APP_VERSION + ' loaded');
        
        const APP = {
            config: {
                adminPass: 'admin123',
                // Automatically detect the correct URL based on where app is running
                wsUrl: window.location.protocol === 'https:' 
                    ? `wss://${window.location.host}` 
                    : `ws://${window.location.host}`,
                apiUrl: `${window.location.origin}/api`
            },
            
            state: {
                user: null,
                students: [],
                callActive: false,
                callData: null,
                callStartTime: null,
                callTimer: null,
                statusPoller: null,
                ws: null,
                wsConnected: false,
                wsPingInterval: null
            },
            
            init() {
                this.loadData();
                // Check if we're in a sandboxed environment
                const isSandboxed = window.location.href.includes('about:srcdoc') || 
                                   (window.self !== window.top);
                
                if (isSandboxed) {
                    console.log('‚úÖ LOCAL MODE: Running without backend - All features work offline!');
                    this.state.wsConnected = false;
                    document.getElementById('lastUpdate').textContent = 'Local Mode ‚úÖ';
                } else {
                    this.connectWebSocket();
                }
            },
            
            loadData() {
                // Try to load from localStorage first
                const saved = localStorage.getItem('students_quran');
                if (saved) {
                    try {
                        this.state.students = JSON.parse(saved);
                        console.log('‚úÖ Loaded', this.state.students.length, 'students from storage');
                    } catch(e) {
                        this.state.students = [];
                    }
                } else {
                    // Load sample students on first run
                    this.state.students = [
                        { 
                            id: 'student_1', 
                            name: 'Ahmed Mohammed', 
                            email: 'ahmed@test.com',
                            phone: '+12025551001',
                            phoneEncrypted: 'encrypted_1',
                            parent: 'Mohammed Ali'
                        },
                        { 
                            id: 'student_2', 
                            name: 'Fatima Khan', 
                            email: 'fatima@test.com',
                            phone: '+12025551002',
                            phoneEncrypted: 'encrypted_2',
                            parent: 'Khan Family'
                        },
                        { 
                            id: 'student_3', 
                            name: 'Hassan Ali', 
                            email: 'hassan@test.com',
                            phone: '+12025551003',
                            phoneEncrypted: 'encrypted_3',
                            parent: 'Ali Ahmed'
                        }
                    ];
                    localStorage.setItem('students_quran', JSON.stringify(this.state.students));
                    console.log('‚úÖ Loaded 3 sample students');
                }
            },
            
            connectWebSocket() {
                try {
                    this.state.ws = new WebSocket(this.config.wsUrl);
                    
                    this.state.ws.onopen = () => {
                        console.log('‚úÖ WebSocket connected to backend');
                        this.state.wsConnected = true;
                        document.getElementById('lastUpdate').textContent = 'Connected ‚úÖ';
                        
                        // Send keepalive ping every 25 seconds to prevent Render from closing connection
                        this.state.wsPingInterval = setInterval(() => {
                            if (this.state.ws && this.state.ws.readyState === WebSocket.OPEN) {
                                this.state.ws.send(JSON.stringify({ type: 'PING' }));
                                console.log('üèì WebSocket keepalive ping sent');
                            }
                        }, 25000);
                    };
                    
                    this.state.ws.onmessage = (event) => {
                        const msg = JSON.parse(event.data);
                        this.handleWebSocketMessage(msg);
                    };
                    
                    this.state.ws.onerror = (error) => {
                        console.warn('‚ö†Ô∏è WebSocket error - will retry');
                        this.state.wsConnected = false;
                        document.getElementById('lastUpdate').textContent = 'Reconnecting...';
                    };
                    
                    this.state.ws.onclose = () => {
                        console.log('üîå WebSocket disconnected - reconnecting in 3s');
                        this.state.wsConnected = false;
                        document.getElementById('lastUpdate').textContent = 'Reconnecting...';
                        
                        // Clear ping interval
                        if (this.state.wsPingInterval) {
                            clearInterval(this.state.wsPingInterval);
                        }
                        
                        // Reconnect faster
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };
                } catch(e) {
                    console.log('üí° Backend not available - using LOCAL MODE (all features still work!)');
                    this.state.wsConnected = false;
                    document.getElementById('lastUpdate').textContent = 'Local Mode ‚úÖ';
                }
            },
            
            handleWebSocketMessage(msg) {
                // Handle PONG silently
                if (msg.type === 'PONG') {
                    return;
                }
                
                console.log('üì° WS MSG:', msg.type);
                
                switch(msg.type) {
                    case 'CONNECTED':
                        console.log('‚úÖ WebSocket connected');
                        break;
                        
                    case 'CALL_STATE_CHANGED':
                        if (this.state.callActive && msg.data) {
                            console.log('üìû State changed:', msg.data.status);
                        }
                        break;
                        
                    case 'CALL_ENDED':
                        console.log('üìû CALL_ENDED received - ending active call NOW');
                        // ALWAYS end active call when we receive CALL_ENDED
                        if (this.state.callActive) {
                            this.forceEndActiveCall(msg.data?.duration || 0);
                        }
                        break;
                        
                    case 'CALL_FAILED':
                        console.log('‚ùå CALL_FAILED received');
                        if (this.state.callActive) {
                            this.forceEndActiveCall(0);
                        }
                        break;
                        
                    case 'CALL_CONNECTED':
                        if (this.state.callActive && this.state.callData) {
                            this.state.callData.status = 'active';
                            document.getElementById('callStatusText').textContent = 'Connected';
                            document.getElementById('callStatusIndicator').className = 'status-indicator status-active';
                        }
                        break;
                        
                    case 'STUDENT_ADDED':
                    case 'STUDENT_UPDATED':
                    case 'STUDENT_DELETED':
                        this.loadStudents();
                        break;
                }
            },
            
            updateCallState(data) {
                if (this.state.callData?.callId === data.callId) {
                    this.state.callData.status = data.status;
                    this.updateCallUI();
                }
            },
            
            handleCallConnected(data) {
                if (this.state.callData?.callId === data.callId) {
                    this.state.callData.status = 'active';
                    this.state.callData.connectedAt = data.connectedAt;
                    document.getElementById('callStatusText').textContent = 'Connected';
                    document.getElementById('callStatusIndicator').className = 'status-indicator status-active';
                    document.getElementById('btnEndCall').disabled = false;
                    this.updateCallUI();
                }
            },
            
            handleCallEnded(data) {
                console.log('üìû handleCallEnded called');
                console.log('   Received callId:', data.callId);
                console.log('   Stored callId:', this.state.callData?.callId);
                console.log('   Call active:', this.state.callActive);
                
                // More robust check - if we have an active call, end it
                const callIdMatch = this.state.callData?.callId === data.callId;
                const hasActiveCall = this.state.callActive && this.state.callData;
                
                // End the call if: IDs match OR we have any active call
                if (callIdMatch || hasActiveCall) {
                    console.log('‚úÖ Ending call now');
                    
                    // Update state FIRST
                    this.state.callActive = false;
                    if (this.state.callData) {
                        this.state.callData.status = 'ended';
                        this.state.callData.endedAt = data.endedAt;
                        this.state.callData.duration = data.duration;
                    }
                    this.stopCallTimer();
                    
                    // Update UI elements directly
                    const statusText = document.getElementById('callStatusText');
                    const statusIndicator = document.getElementById('callStatusIndicator');
                    const endBtn = document.getElementById('btnEndCall');
                    const callInfo = document.getElementById('callInfo');
                    const callModal = document.getElementById('callModal');
                    
                    const endMessage = data.endedBy === 'remote' ? 'Call Ended (Other Party)' : 'Call Ended';
                    
                    if (statusText) statusText.textContent = endMessage;
                    if (statusText) statusText.style.color = '#ff6b6b';
                    if (statusIndicator) statusIndicator.className = 'status-indicator status-ended';
                    if (endBtn) endBtn.disabled = true;
                    if (callInfo) callInfo.textContent = `Status: ENDED | Duration: ${data.duration || 0}s`;
                    
                    // Show alert
                    const alertMsg = data.endedBy === 'remote' 
                        ? `üìû ${this.state.callData?.studentName || 'Student'} ended the call`
                        : `‚úÖ Call ended`;
                    this.showAlert(alertMsg, 'success');
                    
                    // Close modal IMMEDIATELY
                    if (callModal) {
                        callModal.classList.remove('active');
                        console.log('üö™ Modal closed');
                    }
                    
                    console.log('‚úÖ Call ended and modal closed');
                } else {
                    console.log('‚ÑπÔ∏è No active call to end');
                }
            },
            
            forceEndActiveCall(duration) {
                console.log('üî¥ FORCE END CALL - Active:', this.state.callActive);
                
                if (!this.state.callActive) {
                    console.log('‚ÑπÔ∏è No active call to end');
                    return;
                }
                
                // Stop everything FIRST
                this.state.callActive = false;
                this.stopCallTimer();
                
                if (this.state.callData) {
                    this.state.callData.status = 'ended';
                }
                
                // Update UI elements directly and aggressively
                const statusText = document.getElementById('callStatusText');
                const statusIndicator = document.getElementById('callStatusIndicator');
                const endBtn = document.getElementById('btnEndCall');
                const callInfo = document.getElementById('callInfo');
                const callModal = document.getElementById('callModal');
                
                if (statusText) statusText.textContent = 'Call Ended';
                if (statusText) statusText.style.color = '#ff6b6b';
                if (statusIndicator) statusIndicator.className = 'status-indicator status-ended';
                if (endBtn) endBtn.disabled = true;
                if (callInfo) callInfo.textContent = `Status: ENDED | Duration: ${duration}s`;
                
                // Show alert
                this.showAlert(`‚úÖ Call ended - Duration: ${duration}s`, 'success');
                
                // Close modal IMMEDIATELY (no delay)
                if (callModal) {
                    callModal.classList.remove('active');
                    console.log('üö™ Modal closed immediately');
                }
                
                console.log('‚úÖ Call ended successfully');
            },
            
            handleCallFailed(data) {
                if (this.state.callData?.callId === data.callId) {
                    this.state.callData.status = 'failed';
                    this.state.callData.failReason = data.reason;
                    this.stopCallTimer();
                    document.getElementById('callStatusText').textContent = 'Call Failed';
                    document.getElementById('callStatusIndicator').className = 'status-indicator status-failed';
                    document.getElementById('btnEndCall').disabled = true;
                    const errorBox = document.getElementById('errorBox');
                    errorBox.textContent = `‚ö†Ô∏è ${data.reason}`;
                    errorBox.classList.remove('hidden');
                    document.getElementById('btnRetry').classList.remove('hidden');
                    this.updateCallUI();
                }
            },
            
            updateCallUI() {
                const data = this.state.callData;
                if (!data) return;
                
                document.getElementById('callInfo').textContent = `Status: ${data.status.toUpperCase()}`;
                if (data.duration) {
                    document.getElementById('callInfo').textContent += ` | Duration: ${data.duration}s`;
                }
            },
            
            togglePassword(fieldId) {
                const field = document.getElementById(fieldId);
                field.type = field.type === 'password' ? 'text' : 'password';
            },
            
            showAlert(message, type = 'error') {
                const alert = document.createElement('div');
                alert.className = `alert-popup ${type}`;
                alert.innerHTML = `<div class="alert-text">${message}</div>`;
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            },
            
            clearErrors() {
                document.getElementById('passAdmin').classList.remove('error-input');
                document.getElementById('passAdminError').textContent = '';
                document.getElementById('emailStaff').classList.remove('error-input');
                document.getElementById('emailStaffError').textContent = '';
                document.getElementById('passStaff').classList.remove('error-input');
                document.getElementById('passStaffError').textContent = '';
            },
            
            switchTab(tab) {
                this.clearErrors();
                document.getElementById('tabAdmin').classList.remove('active');
                document.getElementById('tabStaff').classList.remove('active');
                
                if (tab === 'admin') {
                    document.getElementById('tabAdmin').classList.add('active');
                    document.getElementById('formAdmin').classList.remove('hidden');
                    document.getElementById('formStaff').classList.add('hidden');
                } else {
                    document.getElementById('tabStaff').classList.add('active');
                    document.getElementById('formAdmin').classList.add('hidden');
                    document.getElementById('formStaff').classList.remove('hidden');
                }
            },
            
            async loginAdmin() {
                this.clearErrors();
                const passField = document.getElementById('passAdmin');
                const pass = passField.value;
                
                if (!pass) {
                    passField.classList.add('error-input');
                    document.getElementById('passAdminError').textContent = '‚ùå Password required';
                    this.showAlert('‚ùå Please enter admin password', 'error');
                    return;
                }
                
                try {
                    // Try to login with backend to get token
                    let data = null;
                    try {
                        const res = await Promise.race([
                            fetch(`${this.config.apiUrl}/auth/login`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    email: 'admin@test.com',
                                    password: pass 
                                })
                            }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000))
                        ]);
                        data = await res.json();
                    } catch(e) {
                        // Offline mode - check hardcoded password
                        console.log('‚ö†Ô∏è Backend not available, using offline mode');
                        if (pass === this.config.adminPass) {
                            data = {
                                success: true,
                                user: { name: 'Administrator', id: 'admin_1', type: 'admin' },
                                token: 'offline_token_' + Date.now()
                            };
                        } else {
                            throw new Error('Invalid password');
                        }
                    }
                    
                    if (data.success) {
                        this.state.user = { 
                            type: data.user.type || 'admin', 
                            name: data.user.name || 'Admin', 
                            avatar: (data.user.name || 'A')[0].toUpperCase(), 
                            id: data.user.id || 'admin',
                            token: data.token
                        };
                        console.log('‚úÖ Admin logged in with token:', data.token ? 'present' : 'missing');
                        this.showDashboard();
                    } else {
                        passField.classList.add('error-input');
                        document.getElementById('passAdminError').textContent = '‚ùå ' + (data.error || 'Invalid password');
                        this.showAlert('‚ùå ' + (data.error || 'Invalid password'), 'error');
                    }
                } catch(e) {
                    passField.classList.add('error-input');
                    document.getElementById('passAdminError').textContent = '‚ùå ' + e.message;
                    this.showAlert('‚ùå ' + e.message, 'error');
                }
            },
            
            async loginStaff() {
                this.clearErrors();
                const emailField = document.getElementById('emailStaff');
                const passField = document.getElementById('passStaff');
                const email = emailField.value.trim();
                const pass = passField.value;
                
                if (!email) {
                    emailField.classList.add('error-input');
                    document.getElementById('emailStaffError').textContent = '‚ùå Email required';
                    return;
                }
                
                if (!pass) {
                    passField.classList.add('error-input');
                    document.getElementById('passStaffError').textContent = '‚ùå Password required';
                    return;
                }
                
                try {
                    // Try to login with backend, but allow offline mode
                    let data = null;
                    try {
                        const res = await Promise.race([
                            fetch(`${this.config.apiUrl}/auth/login`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email, password: pass })
                            }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000))
                        ]);
                        data = await res.json();
                    } catch(e) {
                        // Offline mode - allow demo login
                        if (email === 'john@test.com' && pass === 'password123') {
                            data = {
                                success: true,
                                staff: { name: 'John', id: 'staff_demo' },
                                token: 'demo_token_' + Date.now()
                            };
                        } else {
                            throw new Error('Invalid credentials');
                        }
                    }
                    
                    if (data.success) {
                        this.state.user = {
                            type: 'staff',
                            name: data.staff.name,
                            avatar: data.staff.name[0].toUpperCase(),
                            id: data.staff.id,
                            token: data.token
                        };
                        this.showDashboard();
                    } else {
                        passField.classList.add('error-input');
                        document.getElementById('passStaffError').textContent = '‚ùå Invalid credentials';
                        this.showAlert('‚ùå Invalid email or password', 'error');
                    }
                } catch(e) {
                    passField.classList.add('error-input');
                    document.getElementById('passStaffError').textContent = '‚ùå Invalid credentials';
                    this.showAlert('‚ùå Invalid credentials', 'error');
                }
            },
            
            showDashboard() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.add('show');
                
                document.getElementById('username').textContent = this.state.user.name;
                document.getElementById('role').textContent = this.state.user.type === 'admin' ? 'Administrator' : 'Teacher';
                document.getElementById('avatar').textContent = this.state.user.avatar;
                
                if (this.state.user.type === 'admin') {
                    console.log('‚úÖ Admin logged in - showing admin elements');
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.classList.add('visible');
                        console.log('‚úÖ Showing element:', el);
                    });
                }
                
                this.loadStudents();
                this.updateUI();
            },
            
            async loadStudents() {
                try {
                    const headers = { 'Content-Type': 'application/json' };
                    if (this.state.user.token) {
                        headers['Authorization'] = `Bearer ${this.state.user.token}`;
                    }
                    
                    const res = await fetch(`${this.config.apiUrl}/students`, { 
                        headers,
                        timeout: 2000 
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        this.state.students = data.students;
                        localStorage.setItem('students_quran', JSON.stringify(this.state.students));
                        this.renderStudents();
                    }
                } catch(e) {
                    console.log('üí° Using stored students (offline mode)');
                    // Use stored students in offline mode
                    const saved = localStorage.getItem('students_quran');
                    if (saved) {
                        this.state.students = JSON.parse(saved);
                        this.renderStudents();
                    }
                }
            },
            
            logout() {
                if (confirm('Logout?')) location.reload();
            },
            
            updateUI() {
                this.renderStudents();
                this.updateStats();
                this.showTestingInfo();
            },
            
            showTestingInfo() {
                // Show testing instructions and call logs in console
                const logs = JSON.parse(localStorage.getItem('call_logs_test') || '[]');
                if (logs.length > 0) {
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('üìä CALL SYNCHRONIZATION TEST RESULTS');
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('Total test calls:', logs.length);
                    logs.forEach((log, i) => {
                        console.log(`\nCall ${i + 1}:`);
                        console.log(`  Student: ${log.studentName}`);
                        console.log(`  Duration: ${log.duration}s`);
                        console.log(`  Mode: ${log.syncMode}`);
                        console.log(`  Start: ${new Date(log.startTime).toLocaleTimeString()}`);
                        console.log(`  End: ${new Date(log.endTime).toLocaleTimeString()}`);
                        console.log(`  Status: ${log.status}`);
                    });
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                }
            },
            
            updateStats() {
                document.getElementById('statStudents').textContent = this.state.students.length;
                // Stats would be updated from server
                document.getElementById('statCalls').textContent = '0';
                document.getElementById('statMinutes').textContent = '0';
            },
            
            renderStudents() {
                const list = document.getElementById('studentsList');
                const search = document.getElementById('searchStudents').value.toLowerCase();
                
                let filtered = this.state.students;
                if (search) {
                    filtered = this.state.students.filter(s => s.name.toLowerCase().includes(search));
                }
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div class="empty">No students</div>';
                    return;
                }
                
                list.innerHTML = filtered.map(s => `
                    <div class="card" data-id="${s.id}">
                        <div class="card-name">${s.name}</div>
                        <div class="card-meta">
                            üìß ${s.email || 'N/A'}
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-call" onclick="APP.initiateCall('${s.id}', '${s.name}')">üìû Call</button>
                            ${this.state.user.type === 'admin' ? `
                                <button class="btn btn-edit" onclick="APP.editStudent('${s.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-delete" onclick="APP.deleteStudent('${s.id}')">üóëÔ∏è</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            },
            
            async initiateCall(studentId, studentName) {
                if (this.state.callActive) {
                    this.showAlert('‚ùå A call is already in progress', 'error');
                    return;
                }
                
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.state.user.token || 'demo'}`
                    };
                    
                    // Try to reach backend, but continue if offline
                    let response = null;
                    try {
                        const res = await Promise.race([
                            fetch(`${this.config.apiUrl}/calls/initiate`, {
                                method: 'POST',
                                headers,
                                body: JSON.stringify({
                                    studentId,
                                    staffId: this.state.user.id
                                })
                            }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                        ]);
                        response = await res.json();
                    } catch(e) {
                        // Backend not available - use offline mode
                        console.log('üí° Using offline mode - simulating call');
                        response = { 
                            success: true, 
                            callId: 'call_' + Date.now()
                        };
                    }
                    
                    if (response.success) {
                        this.state.callActive = true;
                        const storedCallId = response.callSid || response.callId;
                        console.log('üìû Call initiated - Stored callId:', storedCallId);
                        
                        this.state.callData = {
                            callId: storedCallId,
                            studentName,
                            status: 'connecting',
                            startedAt: new Date().toISOString()
                        };
                        this.openCallModal();
                        this.startCallTimer();
                        this.showAlert(`üìû Calling ${studentName}...`, 'success');
                        
                        // Simulate call connection in offline mode
                        setTimeout(() => {
                            if (this.state.callData?.status === 'connecting') {
                                this.state.callData.status = 'active';
                                this.state.callData.connectedAt = new Date().toISOString();
                                document.getElementById('callStatusText').textContent = 'Connected';
                                document.getElementById('callStatusIndicator').className = 'status-indicator status-active';
                                document.getElementById('btnEndCall').disabled = false;
                                this.updateCallUI();
                            }
                        }, 2000);
                    } else {
                        this.showAlert(`‚ùå ${response.message || 'Call failed'}`, 'error');
                    }
                } catch(e) {
                    this.showAlert('‚ùå Call initiation failed: ' + e.message, 'error');
                }
            },
            
            async hangupCall() {
                if (!this.state.callData) return;
                
                const callId = this.state.callData.callId;
                const studentName = this.state.callData.studentName;
                const startTime = new Date(this.state.callData.startedAt);
                const endTime = new Date();
                const duration = Math.floor((endTime - startTime) / 1000);
                
                console.log('‚òéÔ∏è CALL ENDED - SYNC TEST:', {
                    callId,
                    student: studentName,
                    startTime: startTime.toLocaleTimeString(),
                    endTime: endTime.toLocaleTimeString(),
                    duration: duration + 's',
                    status: 'completed'
                });
                
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.state.user.token || 'demo'}`
                    };
                    
                    // Try to reach backend
                    let success = false;
                    try {
                        const res = await Promise.race([
                            fetch(`${this.config.apiUrl}/calls/hangup`, {
                                method: 'POST',
                                headers,
                                body: JSON.stringify({
                                    callSid: callId,
                                    duration: duration
                                })
                            }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000))
                        ]);
                        const data = await res.json();
                        success = data.success;
                    } catch(e) {
                        console.log('üí° Offline mode: Ending call locally');
                        success = true;
                    }
                    
                    if (success) {
                        this.state.callActive = false;
                        this.state.callData = null;
                        this.stopCallTimer();
                        document.getElementById('callStatusText').textContent = 'Call Ended';
                        document.getElementById('callStatusIndicator').className = 'status-indicator status-ended';
                        document.getElementById('btnEndCall').disabled = true;
                        
                        // Log for sync testing
                        this.logCallForTesting({
                            callId,
                            studentName,
                            duration,
                            startTime: startTime.toISOString(),
                            endTime: endTime.toISOString(),
                            status: 'completed',
                            syncMode: this.state.wsConnected ? 'WebSocket' : 'Local Mode'
                        });
                        
                        this.showAlert(`‚úÖ Call ended - ${duration}s | Student: ${studentName}`, 'success');
                        setTimeout(() => this.closeCallModal(), 2000);
                    }
                } catch(e) {
                    console.error('Hangup error:', e);
                    this.showAlert('‚ùå Hangup error: ' + e.message, 'error');
                }
            },
            
            logCallForTesting(callData) {
                // Store call logs for testing and verification
                let logs = JSON.parse(localStorage.getItem('call_logs_test') || '[]');
                logs.push({
                    ...callData,
                    loggedAt: new Date().toISOString()
                });
                localStorage.setItem('call_logs_test', JSON.stringify(logs));
                
                console.log('‚úÖ CALL LOGGED:', callData);
                console.log('üìä Total test calls:', logs.length);
                
                // Show in console that sync worked
                if (logs.length > 0) {
                    const lastCall = logs[logs.length - 1];
                    console.log('‚è±Ô∏è Last call duration verified:', lastCall.duration, 'seconds');
                }
            },
            
            async retryCall() {
                if (!this.state.callData) return;
                this.closeCallModal();
                const student = this.state.students.find(s => s.id === this.state.callData.studentId);
                if (student) {
                    this.initiateCall(student.id, student.name);
                }
            },
            
            startCallTimer() {
                this.state.callStartTime = Date.now();
                
                // Timer for display
                this.state.callTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.state.callStartTime) / 1000);
                    const min = Math.floor(elapsed / 60);
                    const sec = elapsed % 60;
                    document.getElementById('callTimer').textContent = 
                        `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                }, 1000);
                
                // FALLBACK: Poll server for call status every 2 seconds
                // This ensures UI updates even if WebSocket fails
                this.state.statusPoller = setInterval(async () => {
                    if (!this.state.callData || !this.state.callActive) {
                        this.stopStatusPoller();
                        return;
                    }
                    
                    try {
                        const callId = this.state.callData.callId;
                        
                        if (!callId || callId.startsWith('call_') || callId.startsWith('sim_')) {
                            return;
                        }
                        
                        const res = await fetch(`${this.config.apiUrl}/calls/${callId}`, {
                            headers: {
                                'Authorization': `Bearer ${this.state.user?.token || 'demo'}`
                            }
                        });
                        
                        if (res.ok) {
                            const callData = await res.json();
                            console.log('üìä POLL RESULT:', callData.status, '| Active:', this.state.callActive);
                            
                            // Check for ANY status that means call ended
                            const endedStatuses = ['completed', 'busy', 'no-answer', 'failed', 'canceled'];
                            
                            if (endedStatuses.includes(callData.status) && this.state.callActive) {
                                console.log('üîÑ POLL DETECTED CALL ENDED - Forcing UI update');
                                this.forceEndActiveCall(callData.duration || 0);
                            }
                        }
                    } catch (e) {
                        // Silent fail
                    }
                }, 2000);
            },
            
            stopStatusPoller() {
                if (this.state.statusPoller) {
                    clearInterval(this.state.statusPoller);
                    this.state.statusPoller = null;
                }
            },
            
            stopCallTimer() {
                if (this.state.callTimer) {
                    clearInterval(this.state.callTimer);
                    this.state.callTimer = null;
                }
                this.stopStatusPoller();
            },
            
            openCallModal() {
                const modal = document.getElementById('callModal');
                document.getElementById('callName').textContent = this.state.callData.studentName;
                document.getElementById('callStatusText').textContent = 'Connecting...';
                document.getElementById('callStatusIndicator').className = 'status-indicator status-connecting';
                document.getElementById('btnEndCall').disabled = false;
                document.getElementById('btnRetry').classList.add('hidden');
                document.getElementById('errorBox').classList.add('hidden');
                modal.classList.add('active');
            },
            
            closeCallModal() {
                document.getElementById('callModal').classList.remove('active');
            },
            
            openModal() {
                // Clear all fields
                document.getElementById('inName').value = '';
                document.getElementById('inPhone').value = '';
                document.getElementById('inParent').value = '';
                document.getElementById('inEmail').value = '';
                
                // Clear all errors
                document.getElementById('nameError').textContent = '';
                document.getElementById('phoneError').textContent = '';
                document.getElementById('emailError').textContent = '';
                document.getElementById('parentError').textContent = '';
                
                // Clear info message
                document.getElementById('formInfo').className = '';
                document.getElementById('formInfo').textContent = '';
                
                // Set header
                document.getElementById('modalTitle').textContent = '‚ûï Add New Student';
                
                // Show modal
                document.getElementById('modal').classList.add('show');
                
                // Focus on name field
                setTimeout(() => document.getElementById('inName').focus(), 100);
                
                console.log('üìù Add Student form opened');
            },
            
            editStudent(id) {
                const s = this.state.students.find(x => x.id === id);
                if (!s) return;
                
                document.getElementById('modalTitle').textContent = 'Edit Student';
                document.getElementById('inName').value = s.name;
                document.getElementById('inPhone').value = s.phone.replace('+1', '');
                document.getElementById('inParent').value = s.parent || '';
                document.getElementById('inEmail').value = s.email || '';
                document.getElementById('modal').classList.add('show');
            },
            
            closeModal() {
                document.getElementById('modal').classList.remove('show');
            },
            
            async saveStudent() {
                // Clear previous errors
                document.getElementById('nameError').textContent = '';
                document.getElementById('phoneError').textContent = '';
                document.getElementById('emailError').textContent = '';
                document.getElementById('parentError').textContent = '';
                document.getElementById('formInfo').className = '';
                
                const name = document.getElementById('inName').value.trim();
                const phone = document.getElementById('inPhone').value.trim();
                const email = document.getElementById('inEmail').value.trim();
                const parent = document.getElementById('inParent').value.trim();
                
                // Validation
                let hasErrors = false;
                
                if (!name) {
                    document.getElementById('nameError').textContent = '‚ùå Student name is required';
                    hasErrors = true;
                }
                
                if (!phone) {
                    document.getElementById('phoneError').textContent = '‚ùå Phone number is required';
                    hasErrors = true;
                } else {
                    const clean = phone.replace(/\D/g, '');
                    if (clean.length !== 10) {
                        document.getElementById('phoneError').textContent = '‚ùå Phone must be exactly 10 digits';
                        hasErrors = true;
                    }
                }
                
                if (email && !this.validateEmail(email)) {
                    document.getElementById('emailError').textContent = '‚ùå Invalid email format';
                    hasErrors = true;
                }
                
                if (hasErrors) {
                    this.showFormInfo('‚ùå Please fix the errors above', 'error');
                    return;
                }
                
                // Show saving state
                this.showFormInfo('‚è≥ Saving student...', 'info');
                
                try {
                    const clean = phone.replace(/\D/g, '');
                    
                    // Try backend first, but allow offline mode
                    let data = null;
                    try {
                        const res = await Promise.race([
                            fetch(`${this.config.apiUrl}/students`, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + (this.state.user?.token || 'demo')
                                },
                                body: JSON.stringify({
                                    name,
                                    phone: clean,
                                    parent,
                                    email
                                })
                            }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                        ]);
                        data = await res.json();
                    } catch(e) {
                        // Offline mode - add locally
                        console.log('üí° Adding student locally (offline mode)');
                        data = { success: true };
                        
                        const newStudent = {
                            id: 'student_' + Date.now(),
                            name,
                            phone: '+1' + clean,
                            phoneEncrypted: 'encrypted_' + Date.now(),
                            parent: parent || 'Not specified',
                            email: email || 'Not provided',
                            createdAt: new Date().toISOString()
                        };
                        this.state.students.push(newStudent);
                        localStorage.setItem('students_quran', JSON.stringify(this.state.students));
                    }
                    
                    if (data.success) {
                        // Show success with details
                        this.showFormInfo(
                            `‚úÖ SUCCESS! Student "${name}" added with phone +1${clean}`,
                            'success'
                        );
                        
                        console.log('‚úÖ STUDENT ADDED:', {
                            name,
                            phone: '+1' + clean,
                            email: email || 'N/A',
                            parent: parent || 'N/A',
                            addedAt: new Date().toLocaleTimeString()
                        });
                        
                        // Refresh and close after 2 seconds
                        setTimeout(() => {
                            this.loadStudents();
                            this.closeModal();
                            this.showAlert(`‚úÖ ${name} added successfully!`, 'success');
                        }, 2000);
                    } else {
                        this.showFormInfo('‚ùå Failed to save: ' + (data.message || 'Unknown error'), 'error');
                    }
                } catch(e) {
                    this.showFormInfo('‚ùå Error: ' + e.message, 'error');
                    console.error('Save error:', e);
                }
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            showFormInfo(message, type) {
                const info = document.getElementById('formInfo');
                info.textContent = message;
                info.className = `modal-info show ${type}`;
            },
            
            async deleteStudent(id) {
                if (!confirm('Delete this student?')) return;
                
                try {
                    // Try backend first
                    try {
                        const res = await Promise.race([
                            fetch(`${this.config.apiUrl}/students/${id}`, {
                                method: 'DELETE',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${this.state.user?.token || 'demo'}`
                                }
                            }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000))
                        ]);
                        const data = await res.json();
                        if (data.success) {
                            this.state.students = this.state.students.filter(s => s.id !== id);
                        }
                    } catch(e) {
                        // Delete locally
                        this.state.students = this.state.students.filter(s => s.id !== id);
                    }
                    
                    localStorage.setItem('students_quran', JSON.stringify(this.state.students));
                    this.loadStudents();
                    this.showAlert('‚úÖ Student deleted!', 'success');
                } catch(e) {
                    this.showAlert('‚ùå Delete error: ' + e.message, 'error');
                }
            },
            
            // ============ TESTING & VERIFICATION ============
            
            getTestResults() {
                return JSON.parse(localStorage.getItem('call_logs_test') || '[]');
            },
            
            clearTestLogs() {
                localStorage.removeItem('call_logs_test');
                console.log('‚úÖ Test logs cleared');
                this.showAlert('‚úÖ Test logs cleared', 'success');
            },
            
            showTestVerification() {
                const logs = this.getTestResults();
                if (logs.length === 0) {
                    console.log('‚ÑπÔ∏è No test calls yet. Try calling a student to test synchronization.');
                    return;
                }
                
                console.clear();
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #6366f1; font-weight: bold;');
                console.log('%cüìû CALL SYNCHRONIZATION TEST VERIFICATION', 'color: #10b981; font-weight: bold; font-size: 14px');
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #6366f1; font-weight: bold;');
                
                logs.forEach((log, index) => {
                    const syncStatus = log.syncMode === 'WebSocket' ? '‚úÖ REAL-TIME' : '‚úÖ LOCAL';
                    console.log(`\n%cüìå Call ${index + 1}:`, 'color: #6366f1; font-weight: bold');
                    console.log(`   Student: ${log.studentName}`);
                    console.log(`   Call ID: ${log.callId}`);
                    console.log(`   Duration: ${log.duration} seconds`);
                    console.log(`   Sync Mode: ${syncStatus}`);
                    console.log(`   Started: ${new Date(log.startTime).toLocaleTimeString()}`);
                    console.log(`   Ended: ${new Date(log.endTime).toLocaleTimeString()}`);
                    console.log(`   Status: ${log.status}`);
                });
                
                console.log(`\n%c‚úÖ Total Test Calls: ${logs.length}`, 'color: #10b981; font-weight: bold; font-size: 12px');
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #6366f1; font-weight: bold;');
            },
            
            viewTestInstructions() {
                console.clear();
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #6366f1; font-weight: bold;');
                console.log('%cüìû CALL SYNCHRONIZATION TESTING GUIDE', 'color: #10b981; font-weight: bold; font-size: 14px');
                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #6366f1; font-weight: bold;');
                console.log(`\n%c‚úÖ STEP 1: ADD STUDENTS`, 'color: #6366f1; font-weight: bold');
                console.log('   1. Click "+ Add Student" button in Admin portal');
                console.log('   2. Fill in: Name, Phone (10 digits), Email, Parent');
                console.log('   3. Click Save');
                console.log('   4. New student appears in the list');
                
                console.log(`\n%c‚úÖ STEP 2: TEST SINGLE CALL (Local Mode)`, 'color: #6366f1; font-weight: bold');
                console.log('   1. Select a student from the list');
                console.log('   2. Click "üìû Call" button');
                console.log('   3. Watch the call timer start (00:00, 00:01...)');
                console.log('   4. Wait 5-10 seconds');
                console.log('   5. Click "‚úã Hangup" button');
                console.log('   6. Check console: APP.showTestVerification()');
                
                console.log(`\n%c‚úÖ STEP 3: TEST TWO-WAY SYNC (Open 2 Browser Tabs)`, 'color: #6366f1; font-weight: bold');
                console.log('   Browser Tab 1 (Call Initiator):');
                console.log('     1. Login as Admin (pass: admin123)');
                console.log('     2. Add a new student');
                console.log('     3. Select student');
                console.log('     4. Click "üìû Call"');
                console.log('     5. Wait 5 seconds');
                console.log('     6. Click "‚úã Hangup"');
                
                console.log('\n   Browser Tab 2 (Monitoring - optional):');
                console.log('     1. Open same app in another tab');
                console.log('     2. Login as same admin');
                console.log('     3. Keep open and watch');
                console.log('     4. When Tab 1 calls, Tab 2 should see status updates');
                console.log('     5. When Tab 1 hangups, Tab 2 shows call ended immediately');
                
                console.log(`\n%c‚úÖ WHAT TO VERIFY:`, 'color: #10b981; font-weight: bold');
                console.log('   ‚úì Call timer counts up correctly');
                console.log('   ‚úì Call duration saved accurately');
                console.log('   ‚úì Call status shows as "completed"');
                console.log('   ‚úì Student name displays correctly');
                console.log('   ‚úì Both tabs see same call state (if 2 tabs)');
                console.log('   ‚úì Call logs show in verification');
                
                console.log(`\n%c‚úÖ CONSOLE COMMANDS:`, 'color: #10b981; font-weight: bold');
                console.log('   ‚Ä¢ APP.getTestResults()       - View all test calls');
                console.log('   ‚Ä¢ APP.showTestVerification() - Show formatted results');
                console.log('   ‚Ä¢ APP.clearTestLogs()        - Clear test history');
                console.log('   ‚Ä¢ APP.state.students         - List all students');
                console.log('   ‚Ä¢ APP.state.user             - Current logged-in user');
                console.log('\n%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #6366f1; font-weight: bold;');
                console.log('%c\n‚úÖ Ready to test! Follow steps above.', 'color: #10b981; font-weight: bold; font-size: 12px');
            }
        };
        
        window.addEventListener('load', () => {
            APP.init();
            
            // Add phone number formatting
            const phoneInput = document.getElementById('inPhone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 10) value = value.slice(0, 10);
                    
                    if (value.length > 0) {
                        if (value.length <= 3) {
                            e.target.value = value;
                        } else if (value.length <= 6) {
                            e.target.value = value.slice(0, 3) + '-' + value.slice(3);
                        } else {
                            e.target.value = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6);
                        }
                    }
                });
            }
            
            setTimeout(() => {
                if (window.location.href.includes('about:srcdoc')) {
                    console.log('%cüí° TIP: Click "‚ûï Add New Student" button to add students!', 'color: #f59e0b; font-weight: bold');
                }
            }, 1000);
        });
    </script>
</body>
</html>
